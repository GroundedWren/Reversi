<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="Reversi player">
	<title>Reversi</title>

	<script>
		/**
		 * A script for a loading veil
		 * @author Vera Konigin vera@groundedwren.com
		 * https://groundedwren.neocities.org
		 */
		window.GW = window.GW || {};
		window.GW.Controls = window.GW.Controls || {};
		(function Veil(ns) {
			ns.DeferKeys = {"DOMContentLoaded": true, "GW.Controls.AccountEl": true};
			
			/**
			 * Defers the lowering of the veil until a key is cleared
			 * @param {string} key The defer key to keep the veil up
			 */
			ns.addDefer = function addDefer(key) {
				ns.DeferKeys[key] = true;
			}
			
			/**
			 * Marks a defer key as complete and clears the veil if no remain
			 * @param {string} key The key to clear
			 */
			ns.clearDefer = function clearDefer(key) {
				delete ns.DeferKeys[key];
				if(Object.keys(ns.DeferKeys).length === 0) {
					requestAnimationFrame(() => document.getElementById("styGwLoad")?.remove());
				}
			}
			
			document.head.insertAdjacentHTML("beforeend", `
				<style id="styGwLoad">
					body {
						opacity: 0;
					}
					html {
						width: 100vw;
						height: 100vh;
						background-color: var(--veil-light-color, #E3E3E3) !important;
					}
					@media(prefers-color-scheme: dark) {
						html {
							background-color: var(--veil-dark-color, #242424) !important;
						}
					}
				</style>
			`);
			window.addEventListener("DOMContentLoaded", function onDOMContentLoadedVeil() {
				ns.clearDefer("DOMContentLoaded");
				setTimeout(() => document.getElementById("styGwLoad")?.remove(), 3000);
			});
		}) (window.GW.Controls.Veil = window.GW.Controls.Veil || {});
	</script>

	<link href="./Styles/variables.css" rel="stylesheet" type="text/css">
	<link href="./Styles/main.css" rel="stylesheet" type="text/css">

	<script src="./Scripts/ActionBatcherGizmo.js"></script>
	<script src="./Scripts/SVGIconControl.js"></script>
	<script src="./Scripts/SwitchControl.js"></script>
	<script src="./Scripts/ToasterControl.js"></script>
	<script src="./Scripts/ShortcutsControl.js"></script>
	<script src="./Scripts/OptionListboxControl.js"></script>
	<script type="module" src="./Scripts/AccountControl.js"></script>
	
	<script src="./Scripts/Display.js"></script>
	<script src="./Scripts/Reversi.js"></script>
	<script src="./Scripts/CellControl.js"></script>

	<link href="./Styles/index.css" rel="stylesheet" type="text/css">
	<script src="./Scripts/index.js"></script>
</head>
<body>
	<header>
		<div>
			<a class="hide-until-focus full" href="#main">Skip to content</a>
			<noscript><strong>This site may not function properly without JavaScript enabled.</strong></noscript>
			<a class="full" href="https://groundedwren.com/Pages/Games.html">Grounded Wren Games</a>
		</div>
		<div><h1>Reversi</h1></div>
		<div class="bubble-container">
			<button onclick="document.getElementById('diaInfo').showModal()">
				<gw-icon iconKey="circle-info" name="Instructions"></gw-icon>
			</button>
			<gw-account
				apiKey="AIzaSyDWkr2_TkwU9bQg0vS8OaLpMkcVCExeCow"
				authDomain="groundedwren.firebaseapp.com"
				projectId="groundedwren"
				storageBucket="groundedwren.firebasestorage.app"
				messagingSenderId="967981787659"
				appId="1:967981787659:web:87d5e9396be3f89df4350e"
			></gw-account>
			<details class="bubbler">
				<summary>
					<gw-icon iconKey="gear" name="Settings"></gw-icon>
				</summary>
				<div class="bubble">
					<label>
						<gw-switch><input id="cbxDarkMode"
							type="checkbox"
							oninput="localStorage.setItem('theme', event.target.checked ? 'dark' : 'light');GW.Reversi.Display.updatePrefs();"
						></gw-switch>
						Dark mode
					</label>
					<label>
						<gw-switch><input id="cbxRevealMoves"
							type="checkbox"
							oninput="localStorage.setItem('reveal-moves', event.target.checked ? 'true' : 'false');GW.Reversi.Display.updatePrefs();"
						></gw-switch>
						Reveal moves
					</label>
				</div>
			</details>
			<button onclick="document.getElementById('diaNew').showModal()">New Game</button>
		</div>
	</header>
	<main id="main">
		<gw-shortcuts id="shortsGame"
			role="application"
			aria-labelledby="spnGameLbl"
			aria-describedby="asiGame"

			code_0="ArrowRight"
			handler_0="GW.Reversi.gameKbdNav(event)"
			info_0="Move right a column"

			code_1="ArrowLeft"
			handler_1="GW.Reversi.gameKbdNav(event)"
			info_1="Move left a column"

			code_2="ArrowUp"
			handler_2="GW.Reversi.gameKbdNav(event)"
			info_2="Move up a row"

			code_3="ArrowDown"
			handler_3="GW.Reversi.gameKbdNav(event)"
			info_3="Move down a column"

			code_4="PageUp"
			handler_4="GW.Reversi.gameBtnJump(event)"
			info_4="Jump to the previous button"

			code_5="PageDown"
			handler_5="GW.Reversi.gameBtnJump(event)"
			info_5="Jump to the next button"

			code_6="Control+Z"
			handler_6="GW.Reversi.undo(event)"
			info_6="Undo the last action"

			code_7="Alt+S"
			handler_7="GW.Controls.Shortcuts.reportShortcuts(event)"
			info_7="Displays available shortcuts"

			code_8="Alt+G"
			handler_8="GW.Reversi.moveGreedily()"
			info_8="Performs a greedy move"
		>
			<div id="divBoardContainer">
				<table id="tblBoard" 
					role="grid" 
					aria-labelledby="spnGameBoardLbl" 
					tabindex="0"
				></table>
			</div>
			<aside id="asiGame" style="visibility: hidden;">
				<gw-icon iconKey="keyboard" name="Keyboard navigation available"></gw-icon>
				<span class="sr-only">in focus mode</span>
				<span>(<kbd>Alt</kbd>+<kbd>S</kbd>)</span>
			</aside>
		</gw-shortcuts>
		<div id="rightArticles">
			<article id="artInfo" aria-labelledby="hInfo">
				<h2 id="hInfo">Info</h2>
				<span id="spnStatus" tabindex="-1">
					<strong id="strBtm" class="black-callout">Black</strong>
					<strong id="strWtm" class="white-callout">White</strong>
					<span id="spnToMove">&nbsp;to move</span>
					<span id="spnWins">&nbsp;wins!</span>
				</span>
				<span id="spnLockedPpc">
					<strong id="strLockedPpcBlack" class="black-callout">Black</strong>
					<strong id="strLockedPpcWhite" class="white-callout">White</strong>
					is your color
				</span>
				<table>
					<tbody>
						<tr>
							<th scope="row">Black:</th><td id="tdBlackCount"></td>
						</tr>
						<tr>
							<th scope="row">White:</th><td id="tdWhiteCount"></td>
						</tr>
						<tr>
							<th scope="row">Blank:</th><td id="tdBlankCount"></td>
						</tr>
					</tbody>
				</table>
				<label><gw-switch><input id="cbxShowPrev" type="checkbox"></gw-switch> Show previous</label>
				<button id="btnGrd" onclick="GW.Reversi.moveGreedily()">Greedy Move</button>
				<button id="btnReset" onclick="GW.Reversi.reset()" class="hidden">Reset</button>
				<button id="btnPass" onclick="GW.Reversi.passTurn()" class="hidden">Pass</button>
				<button id="btnUndo" disabled onclick="GW.Reversi.undo()">Undo</button>
			</article>
			<article id="artOnline" aria-labelledby="hOnline">
				<h2 id="hOnline">Online</h2>
				<output id="outConnected" tabindex="-1"></output>
				<button id="btnPush" onclick="GW.Reversi.pushChanges()">Push changes</button>
			</article>
		</div>
	</main>
	<footer>
		<figure>
			<a href="https://www.groundedwren.com/" target="_blank">
				<img src="./Img/gw-button.png" alt="Grounded Wren 88x31 Button; white text on a swirling purple, red, and black background">
			</a>
			<figcaption>Created by Vera in 2025</figcaption>
		</figure>
	</footer>
	<dialog id="diaInfo" aria-labelledby="icoInfo">
		<article>
			<gw-icon id="icoInfo" iconKey="circle-info" name="info" tabindex="-1" role="heading" aria-level="1" autofocus></gw-icon>
			<article>
				<h2>Intro</h2>
				<p>
					Welcome to the Grounded Wren Reversi player!
				</p>
				<p>
					Reversi dates back to the 1800s, and the <q>Othello</q> variant (used here) was codified in the 1970s.
					The rules are simple, but the skill ceiling is high - you have to plan ahead or a board seemingly covered by your pieces can reverse(i) in the blink of an eye!
				</p>
				<h2>How to Play</h2>
				<p>
					Reversi is played with two players - one uses <em>black</em> pieces, the other <em>white</em>.
					 Players take turns and move once per turn if they are able (and pass if they have no legal moves).
					 The game ends once there are no legal moves remaining (usually when the board is filled), and the player with more pieces on the board wins.
				</p>
				<p>
					To make a move, you must choose an empty cell in which to place one of your pieces. A cell is legal if you can follow a straight line of adjacent cells over your opponent's pieces back to your own.
					 Once your move is made, all the pieces in each of these lines are replaced with your pieces. (In a physical game, you would turn the pieces over to do this).
				</p>
				<p>
					You may take turns with someone if you are sharing a computer, or you may press the <q>Greedy Move</q> button on your opponent's turn to play against a simple bot.
				</p>
				<h2>Online Play</h2>
				<p>
					You can now play games over the internet with a friend! To get started, create an account with a username and email, then start a new game.
					 You'll have access to a form to host a game with a name and passkey. Once you've begun hosting a game, give your friend the name and passkey, which they'll use to connect.
					 After each of your moves, you will need to click "Push changes" to sync them to your friend.
				</p>
			</article>
			<footer>
				<a class="full" href="mailto:vera@groundedwren.com?subject=Reversi">Give feedback</a>
				<button onclick="document.getElementById('diaInfo').close();">Close</button>
			</footer>
		</article>
	</dialog>
	<dialog id="diaNew" aria-labelledby="hNew">
		<article aria-labelledby="hNew">
			<h2 id="hNew">New Game</h2>
			<button id="btnConnect" onclick="GW.Reversi.onConnectClicked()" autofocus>Connect</button>
			<button id="btnHost" onclick="GW.Reversi.onHostClicked()">Host</button>
			<button id="btnLocal" onclick="GW.Reversi.onNewGame()">Local</button>
			<button onclick="document.getElementById('diaNew').close()">Cancel</button>
		</article>
	</dialog>
	<dialog id="diaHost" aria-labelledby="hHost">
		<form id="frmHost" aria-labelledby="hHost" onsubmit="GW.Reversi.onHostSubmit(event)">
			<h3 id="hHost">Host</h3>
			<div class="input-grid">
				<label>
					<span>Game name:</span>
					<input type="text" name="gameName" required autofocus>
				</label>
				<label>
					<span>Game passkey:</span>
					<input type="text" name="gamePass" required>
				</label>
			</div>
			<gw-option-listbox id="olbPpc" data-single="true"><fieldset>
				<legend>Your Piece Color</legend>
				<label><input id="radPpcB" type="radio" name="ppc" value="b" checked="true">Black</label>
				<label><input id="radPpcW" type="radio" name="ppc" value="w">White</label>
			</fieldset></gw-option-listbox>
			<output tabindex="-1"></output>
			<footer>
				<button type="button" onclick="document.getElementById('diaHost').close();">Close</button>
				<button type="submit">Create</button>
			</footer>
		</form>
	</dialog>
	<dialog id="diaConnect" aria-labelledby="hConnect">
		<form aria-labelledby="hConnect" onsubmit="GW.Reversi.onConnectSubmit(event);">
			<h2 id="hConnect">Connect</h2>
			<div class="input-grid">
				<label>
					<span>Game name:</span>
					<input type="text" name="gameName" required autofocus>
				</label>
				<label>
					<span>Game passkey:</span>
					<input type="text" name="gamePass" required>
				</label>
			</div>
			<output tabindex="-1"></output>
			<footer>
				<button type="button" onclick="document.getElementById('diaConnect').close();">Close</button>
				<button type="submit">Connect</button>
			</footer>
		</form>
	</dialog>
	<div class="hidden">
		<span id="spnGameLbl">Reversi</span>
		<span id="spnGameBoardLbl">Board</span>
		<span id="spnCell">Cell</span>
		<span id="spnEmpty">Empty</span>
		<span id="spnBlackPiece">Black piece</span>
		<span id="spnWhitePiece">White piece</span>
		<span id="spnPlacePiece">Place piece</span>
		<span id="spnCellLastMove">Placed most recently</span>
		<span id="spnCellLastFlip">Flipped by the most recent move</span>
	</div>
</body>
</html>